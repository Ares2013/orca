#!/usr/bin/env bash

if [ -z "$1" ]
then
  echo "error: First argument is a directory containing baselines"
  exit 1
fi

if [ -z "$2" ]
then
  echo "error: Second argument is a directory containing test images"
  exit 1
fi

rm -rf diff
mkdir diff

for fullfile in "$1"/*
do
  filename="${fullfile##*/}"
  format="${filename##*.}"

  case "$format" in
    png)
      # Copy as is
      cp "$1/$filename" "diff/$filename.baseline.png"
      cp "$2/$filename" "diff/$filename.png"
      ;;
    pdf)
      # Use ImageMagick to convert PDF to PNG because Inkscape reverse gradients
      convert -density 300 "$fullfile" "diff/$filename.baseline.png"
      convert -density 300 "build/$filename" "diff/$filename.png"
      ;;
    *)
      # Use Inkscape to convert to PNG
      inkscape "$fullfile" --export-dpi 300 --export-png "diff/$filename.baseline.png" 2> inkscape.stderr
      inkscape "build/$filename" --export-dpi 300 --export-png "diff/$filename.png" 2> inkscape.stderr
      ;;
  esac

  # Do exact pixel comparison using ImageMagick
  compare -verbose -metric AE "diff/$filename.baseline.png" "diff/$filename.png" "diff/$filename.diff.png" 2> "diff/$filename.txt" ||
    { cat "diff/$filename.txt"; exit 1; }
  cat "diff/$filename.txt"
done

CODE=$(grep -R "all: [^0]" diff/*.txt | wc -l)

echo "$CODE different images"
exit "$CODE"
